# Release Notes: mcli v7.11.4

**Release Date:** November 1, 2025
**Previous Version:** v7.11.3
**Type:** Bug Fix Release

## Overview

This release fixes a critical bug where workflows with invalid or incomplete code would appear in `mcli workflows --help` but fail silently when attempting to execute them. The fix validates workflow commands during listing to ensure only executable workflows are displayed to users.

## üêõ Bug Fixes

### Workflow Validation During Listing

**Issue:** Workflows with invalid code appeared in command list but couldn't be executed

**Problem Description:**
When users created workflows using `mcli workflow add <name>` and left the code as example comments or invalid Python/shell code, these workflows would:
1. Appear in the output of `mcli workflows --help`
2. Fail silently when attempting to load them
3. Disappear from the list when Click tried to verify they could be loaded
4. Provide no error message to users about why they couldn't be executed

This created a confusing user experience where workflows seemed to exist but were unusable.

**Root Cause:**
The `ScopedWorkflowsGroup.list_commands()` method loaded workflow metadata but didn't validate that the code could be successfully parsed and registered as a Click command. Only later, when Click attempted to load the command for help text generation or execution, would the invalid code cause registration to fail, resulting in the command being filtered out without explanation.

**Solution:**
Modified `list_commands()` to validate each workflow before adding it to the returned list:
- Attempts to register each workflow command in a temporary Click group
- Only includes workflows that successfully register and return a valid command object
- Logs debug messages for workflows that fail validation
- Ensures the command list is consistent between listing and execution

**Example Scenario:**
```bash
# User creates a workflow but leaves example code commented out
$ mcli workflow add my-workflow
# (Saves file with only commented example code)

# Before fix: workflow appears in list
$ mcli workflows --help
Commands:
  my-workflow   Custom command    # <- Shows up but can't be run

# After fix: invalid workflow doesn't appear
$ mcli workflows --help
Commands:
  notebook      Workflow notebook management
  secrets       Secure secrets management
# my-workflow is not shown because it has invalid code
```

## üîß Technical Changes

### Modified Files

**`src/mcli/workflow/workflow.py`** (45 lines changed)
- Modified `list_commands()` to validate workflow code before listing
- Added validation logic to attempt command registration
- Added debug logging for workflows that fail to load
- Simplified workflow command filtering logic

**Changes:**
```python
# Before: Just checked group name
workflow_commands = [cmd.get('name') for cmd in commands if cmd.get('group') == 'workflow']

# After: Validates command can be loaded
workflow_commands = []
for cmd_data in commands:
    if cmd_data.get('group') != 'workflow':
        continue
    
    # Try to register the command to validate it
    temp_group = click.Group()
    language = cmd_data.get("language", "python")
    
    try:
        if language == "shell":
            success = manager.register_shell_command_with_click(cmd_data, temp_group)
        else:
            success = manager.register_command_with_click(cmd_data, temp_group)
        
        # Only add if registration succeeded
        if success and temp_group.commands.get(cmd_name):
            workflow_commands.append(cmd_name)
```

### Validation Logic

The validation process:
1. Loads workflow JSON metadata
2. For each workflow with `group == "workflow"`:
   - Creates a temporary Click group
   - Attempts to register the command (executes Python code or creates shell wrapper)
   - Checks if a valid Click command object was created
   - Only includes the workflow if registration succeeded
3. Returns only validated workflow names

## üìä Statistics

- **Lines Added:** 30
- **Lines Removed:** 15  
- **Files Modified:** 1
- **Net Lines Changed:** +15
- **Bug Severity:** High (user-facing functionality issue)
- **Fix Complexity:** Medium (requires validation logic)

## üîÑ Upgrade Instructions

### For All Users

```bash
# Upgrade via pip
pip install --upgrade mcli-framework

# Or with UV
uv pip install --upgrade mcli-framework

# Verify version
mcli version  # Should show 7.11.4
```

### For uv tool Users

```bash
# Upgrade tool installation
uv tool upgrade mcli-framework

# Or force reinstall
uv tool install --force mcli-framework

# Verify version
mcli version  # Should show 7.11.4
```

## üîÑ Backward Compatibility

- ‚úÖ **Fully backward compatible**
- Valid workflows continue to work exactly as before
- Invalid workflows that were previously "hidden" will now be consistently hidden
- No changes to workflow JSON format or command syntax

## ‚ö†Ô∏è Breaking Changes

None. This is a bug fix that improves consistency.

## üí° User Impact

### Before This Fix

Users would see workflows in `mcli workflows --help` that they couldn't actually run, leading to confusion:

```bash
$ mcli workflows --help
Commands:
  my-broken-workflow   Custom command    # Appears in list
  working-workflow     Another command

$ mcli workflows my-broken-workflow
# Silently fails - no error message, workflow just doesn't run
```

### After This Fix

Users only see workflows that are actually executable:

```bash
$ mcli workflows --help  
Commands:
  working-workflow     Another command
# my-broken-workflow doesn't appear because it has invalid code

$ mcli workflows my-broken-workflow  
Error: No such command 'my-broken-workflow'.
# Clear error message if user tries to run it
```

## üìñ For Workflow Authors

If you have workflows that are no longer appearing after this upgrade:

1. **Check your workflow code:**
   ```bash
   mcli workflow edit <workflow-name>
   ```

2. **Common issues:**
   - Code is all commented out (example code not uncommented)
   - Missing Click command decorator (`@click.command()`)
   - Syntax errors in Python code
   - Missing shebang or invalid shell syntax (for shell workflows)

3. **Fix the code:**
   - Uncomment and customize the example code
   - Add proper Click decorators
   - Test the Python/shell syntax
   
4. **Verify it appears:**
   ```bash
   mcli workflows --help  # Should now show your workflow
   ```

## üêõ Known Issues

None at this time.

## üîó Links

- **PyPI Package:** https://pypi.org/project/mcli-framework/
- **GitHub Repository:** https://github.com/gwicho38/mcli
- **Documentation:** https://github.com/gwicho38/mcli/tree/main/docs
- **Previous Release:** [v7.11.3](./7.11.3.md)

## üéØ What's Next

Future improvements being considered:
- Better error messages when workflow code is invalid
- `mcli workflow validate <name>` command to check workflow syntax
- Automatic workflow templates with working example code
- Workflow testing framework

---

**Full Changelog:** https://github.com/gwicho38/mcli-framework/compare/v7.11.3...v7.11.4
