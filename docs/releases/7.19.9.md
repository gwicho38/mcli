# Release 7.19.9

**Release Date:** 2025-11-28

## Summary

This release consolidates hardcoded `.mcli` strings into constants and significantly improves Jupyter notebook workflow support, including async command support and automatic project venv detection.

## Features

### Improved Notebook Command Loading
- **Group Subcommand Support:** Notebooks can now define their own Click groups with subcommands using `@group.command()` pattern
- **Async Command Support:** Commands decorated with custom async wrappers (e.g., `@click_async`) now work correctly
- **Project Venv Detection:** Automatically detects and uses the project's virtual environment for imports, so notebooks can use project-specific packages

### Constants Consolidation
- **Centralized Directory Names:** All hardcoded `.mcli` directory references now use `DirNames.MCLI` constant
- **Preparation for Configurability:** This enables future support for custom directory names via environment variable

## Bug Fixes

### Notebook Command Loader
- **Fixed:** `@group.command()` pattern was not recognized (only `@click.command()` worked)
- **Fixed:** Import errors in notebook cells caused entire cell to fail, losing definitions like `logger`
- **Fixed:** Notebooks couldn't import packages from project's venv (e.g., `pdf2image`, project-local modules)

### Line-by-Line Cell Execution
- When a cell fails due to missing imports, mcli now executes statements individually to salvage working code
- This handles cases where imports and definitions are mixed in the same cell

## Files Changed

### Modified - Constants Consolidation
- `src/mcli/lib/constants/storage.py` - Use `DirNames.MCLI` for storage paths
- `src/mcli/lib/paths.py` - Use `DirNames.MCLI` for home directory resolution
- `src/mcli/lib/services/redis_service.py` - Use constant for redis data directory
- `src/mcli/lib/secrets/manager.py` - Use constant for secrets directory
- `src/mcli/lib/secrets/repl.py` - Use constant for history file
- `src/mcli/lib/secrets/store.py` - Use constant for config file
- `src/mcli/lib/makefile_workflows.py` - Use constant for Makefile lookup
- `src/mcli/lib/packagejson_workflows.py` - Use constant for package.json lookup
- `src/mcli/self/store_cmd.py` - Use constant for commands path
- `src/mcli/self/migrate_cmd.py` - Use constant for migration directories
- `src/mcli/app/model_cmd.py` - Use constant for model.json path
- `src/mcli/app/commands_cmd.py` - Use constant for commands path
- `src/mcli/workflow/lsh_integration.py` - Use constant for lsh.env path
- `src/mcli/workflow/scheduler/persistence.py` - Use constant for scheduler directory
- `src/mcli/chat/command_rag.py` - Use constant for command cache directory

### Modified - Notebook Loader Improvements
- `src/mcli/workflow/notebook/command_loader.py`
  - Added `_find_project_venv()` to locate project's virtual environment
  - Added `_setup_project_imports()` to configure sys.path for project imports
  - Added `_execute_cell_line_by_line()` for graceful handling of partial cell failures
  - Updated `_is_command_cell()` to recognize `@group.command()` patterns
  - Updated `extract_commands()` to extract subcommands from user-defined groups
  - Updated `create_group()` to use notebook-defined groups instead of creating wrappers

## Migration Notes

No action required. All changes are backwards compatible.

## Testing

- All 822 fast tests pass
- Tested notebook command loading with async functions
- Tested project venv detection and import resolution

## Known Issues

None

## Contributors

- Luis Fernandez de la Vara

---

**Full Changelog:** https://github.com/gwicho38/mcli/compare/v7.19.8...v7.19.9
