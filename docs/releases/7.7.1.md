# Release 7.7.1

**Release Date**: 2025-10-15

## Summary

This release reverts the emulator workflow back to using the Android SDK emulator instead of Genymotion, providing a completely free, open-source, and license-unrestricted solution for headless Android emulator management. Version 7.7.0 attempted to use Genymotion but encountered licensing restrictions that blocked key CLI functionality.

## What Changed from 7.7.0

### Major Changes

#### Android SDK Emulator Restoration
- **Reverted from Genymotion to Android SDK Emulator**: The emulator workflow now uses the Android SDK's `avdmanager` and `emulator` tools instead of Genymotion's `gmtool`
- **Completely Free and Open Source**: No licensing restrictions or authentication requirements
- **Fully Headless**: Optimized for headless operation with software rendering (swiftshader_indirect)
- **Better Stability on Apple Silicon**: Configured with GPU settings that work reliably on M-series chips

### Why This Change?

Version 7.7.0 introduced Genymotion integration, but this approach had critical issues:

1. **License Restrictions**: Genymotion Personal license blocks CLI template listing and device creation
2. **Authentication Requirements**: Required Genymotion account and online authentication
3. **Commercial Licensing**: Advanced features required paid license
4. **Not Fully Headless**: Genymotion has GUI dependencies

The Android SDK emulator provides:
- ✅ Completely free and open source
- ✅ No license restrictions
- ✅ No authentication required
- ✅ Fully headless operation
- ✅ Direct integration with Flutter and React Native workflows
- ✅ Works with existing AVD configurations

### Features

#### Android Emulator Management
- **AVD Management**: Create, delete, and list Android Virtual Devices (AVDs)
- **Headless Operation**: Start emulators without GUI windows (`-no-window`, `-no-audio`, `-no-boot-anim`)
- **Software Rendering**: Uses `swiftshader_indirect` GPU mode for stability on Apple Silicon
- **Running Status Detection**: Accurately detects which AVDs are currently running via ADB
- **Device Definitions**: List available device profiles (Pixel 6, Pixel 7, etc.)
- **System Images**: List installed Android system images for creating new AVDs

#### Commands

```bash
# List all AVDs with running status
mcli workflow emulator android list

# List only running emulators
mcli workflow emulator android list --running

# Start emulator headlessly (default)
mcli workflow emulator android start <name>

# Start with GUI window
mcli workflow emulator android start <name> --gui

# Start with factory reset
mcli workflow emulator android start <name> --wipe-data

# Stop specific emulator
mcli workflow emulator android stop --serial <emulator-serial>

# Stop all emulators
mcli workflow emulator android stop --all

# Create new AVD
mcli workflow emulator android create <name> --device pixel_6 --system-image "system-images;android-34;google_apis;arm64-v8a"

# Delete AVD
mcli workflow emulator android delete <name>

# List available device definitions
mcli workflow emulator android devices

# List installed system images
mcli workflow emulator android images
```

#### iOS Simulator Support

iOS simulator functionality remains **unchanged** and fully functional:
```bash
mcli workflow emulator ios list
mcli workflow emulator ios start "iPhone 15"
mcli workflow emulator ios stop --identifier "iPhone 15"
mcli workflow emulator ios delete --identifier "iPhone 15"
```

### Test Updates

#### Comprehensive Test Refactoring
- **Updated MockGenymotionManager to MockAndroidEmulatorManager**: All mock objects now reflect Android SDK emulator API
- **New Integration Tests**: Added tests for all Android SDK commands:
  - `avdmanager list avd`
  - `avdmanager list device`
  - `avdmanager create avd`
  - `avdmanager delete avd`
  - `adb devices`
  - `adb emu avd name`
  - `adb emu kill`
- **Updated Error Handling Tests**: Now test Android SDK-specific errors
- **Removed Genymotion Tests**: Eliminated obsolete tests for `gmtool` commands
- **Retained iOS Support**: All iOS simulator tests remain unchanged
- **All 44 tests passing**: Full test coverage with no failures

### Technical Details

#### Files Modified
- `/Users/lefv/.mcli/commands/emulator.json` - Complete rewrite to use Android SDK emulator
- `/Users/lefv/repos/mcli/tests/unit/test_emulator_workflow.py` - Updated all tests to match new implementation
- `/Users/lefv/repos/mcli/pyproject.toml` - Version bump to 7.7.1
- `/Users/lefv/repos/mcli/docs/releases/7.7.1.md` - This release notes file

#### Implementation Details

**Android SDK Path Discovery**:
```python
def get_android_sdk_path() -> Optional[str]:
    """Get Android SDK path from environment or common locations."""
    sdk_path = os.environ.get('ANDROID_HOME') or os.environ.get('ANDROID_SDK_ROOT')
    if sdk_path and os.path.exists(sdk_path):
        return sdk_path

    common_paths = [
        os.path.expanduser("~/android-sdk"),
        os.path.expanduser("~/Android/Sdk"),
        os.path.expanduser("~/Library/Android/sdk"),
        "/usr/local/android-sdk"
    ]

    for path in common_paths:
        if os.path.exists(path):
            return path

    return None
```

**Running Emulator Detection**:
```python
def get_running_emulators(self) -> Dict[str, str]:
    """Get dict of running emulator serial:avd_name."""
    returncode, stdout, _ = self.run_command(["adb", "devices"], check=False)

    if returncode != 0:
        return {}

    devices = {}
    for line in stdout.split('\n')[1:]:  # Skip header
        if 'emulator' in line and 'device' in line:
            serial = line.split()[0]
            # Get AVD name
            returncode2, avd_name, _ = self.run_command(
                ["adb", "-s", serial, "emu", "avd", "name"],
                check=False
            )
            if returncode2 == 0 and avd_name.strip():
                # AVD name is first line, followed by "OK"
                avd_name_clean = avd_name.strip().split('\n')[0]
                devices[serial] = avd_name_clean
            else:
                devices[serial] = serial

    return devices
```

**Headless Emulator Startup**:
```python
def start_emulator(self, name: str, headless: bool = True, **kwargs) -> bool:
    """Start an emulator."""
    emulator = self.get_emulator_path()
    if not emulator:
        console.print("[red]emulator executable not found[/red]")
        return False

    cmd = [emulator, "-avd", name]

    # Headless options
    if headless:
        cmd.extend(["-no-window", "-no-audio", "-no-boot-anim"])

    # GPU mode - use software rendering for stability
    cmd.extend(["-gpu", "swiftshader_indirect"])

    # Additional options
    if kwargs.get('wipe_data'):
        cmd.append("-wipe-data")
    if kwargs.get('read_only'):
        cmd.append("-read-only")

    # Start in background
    subprocess.Popen(
        cmd,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        start_new_session=True
    )

    return True
```

### Dependencies

- **Required**: Android SDK (`ANDROID_HOME` environment variable)
  - `avdmanager` - For AVD creation and management
  - `emulator` - For running AVDs
  - `adb` - For device communication
- **No longer required**: Genymotion, gmtool
- **Retained**: `xcrun` (iOS simulators - unchanged)

### Installation

The Android SDK should already be installed for Flutter/React Native development. If not:

**macOS/Linux**:
```bash
# Install Android SDK via Android Studio or command line tools
# Set ANDROID_HOME environment variable
export ANDROID_HOME=$HOME/android-sdk
export PATH=$PATH:$ANDROID_HOME/emulator
export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
export PATH=$PATH:$ANDROID_HOME/platform-tools
```

**Verify installation**:
```bash
mcli workflow emulator android list
```

### Breaking Changes from 7.7.0

- **Genymotion No Longer Supported**: The workflow no longer uses `gmtool` or Genymotion
- **Different Command Patterns**: Device creation now uses `--device` and `--system-image` instead of `--hwprofile` and `--osimage`
- **No Interactive Mode**: Removed `--interactive` flag (was Genymotion-specific)
- **No Templates Command**: Removed `mcli workflow emulator android templates` (was Genymotion-specific)
- **No Installation Command**: Removed `mcli workflow emulator android install` (was Genymotion-specific)
- **No Open Command**: Removed `mcli workflow emulator android open` (was Genymotion-specific)

### Migration from 7.7.0

#### Before (7.7.0 - Genymotion)
```bash
# See available templates
mcli workflow emulator android templates

# Create device (interactive)
mcli workflow emulator android create MyDevice --interactive

# Create device (manual)
mcli workflow emulator android create MyDevice --hwprofile "Google Pixel 6" --osimage "Android 13.0"
```

#### After (7.7.1 - Android SDK)
```bash
# See available devices and images
mcli workflow emulator android devices
mcli workflow emulator android images

# Create device
mcli workflow emulator android create MyDevice --device pixel_6 --system-image "system-images;android-34;google_apis;arm64-v8a"

# Start device (headless by default)
mcli workflow emulator android start MyDevice
```

### Known Issues

None at this time. The Android SDK emulator is a mature, well-tested solution.

### Test Results

- **44 tests passed** (43 fast tests + 2 slow tests)
- **0 tests failed**
- **Full coverage** of all Android SDK emulator functionality
- All iOS simulator tests remain passing

## Contributors

- MCLI Development Team

## Related Issues

- Resolves: Genymotion licensing restrictions blocking CLI functionality
- Resolves: Authentication requirements for headless emulator management
- Resolves: Need for completely free, open-source emulator solution

---

**Full Changelog**: 7.7.0...7.7.1
