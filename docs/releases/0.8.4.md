# Release 0.8.4

**Release Date:** 2025-10-10

## Summary

This release fixes critical IPv6 connection issues with Supabase database on Streamlit Cloud and improves database configuration handling.

## Changes from v0.8.3 to v0.8.4

### Critical Bug Fixes

#### 1. IPv6 Connection Failure to Supabase Database

**Problem:**
- Streamlit Cloud deployments failed to connect to Supabase database
- Error: `connection to server at "db.*.supabase.co" failed: Cannot assign requested address`
- IPv6 address resolution causing connection failures
- Trading dashboard and ML features were non-functional in production

**Root Cause:**
- session.py prioritized `settings.database.url` which defaulted to SQLite
- DatabaseSettings class uses `DB_` prefix for environment variables (not `DATABASE_URL`)
- Direct Supabase connections resolve to IPv6 addresses
- Streamlit Cloud has limited IPv6 support

**Solution:**
- Prioritize `DATABASE_URL` environment variable over settings
- Use EU region connection poolers (aws-1-eu-north-1) for IPv4-only connectivity
- Implement multi-region pooler failover logic
- Detect placeholder passwords and trigger automatic pooler fallback

**Impact:**
- ‚úÖ Trading dashboard now functional on Streamlit Cloud
- ‚úÖ Database connections work reliably in production
- ‚úÖ IPv4 pooler connections verified working
- ‚úÖ Maintains backward compatibility with local development

### Code Quality Improvements

#### 2. SQLAlchemy 2.0 Compatibility

**Changes:**
- Added `text()` wrapper for all SQL queries in `get_session()`
- Updated connection testing to use `text("SELECT 1")`
- Fixed deprecation warnings

#### 3. Module-Level Initialization Fix

**Problem:**
- Streamlit import at module level caused issues in non-Streamlit contexts
- `st.info()` calls during module initialization failed

**Solution:**
- Replaced Streamlit logging with Python logging module
- Removed module-level Streamlit dependencies
- Added proper logging for database connection status

### Testing

#### New Test Coverage

**Unit Tests (13 total):**
- ‚úÖ Placeholder password detection
- ‚úÖ Pooler URL construction
- ‚úÖ Connection timeout configuration
- ‚úÖ IPv6 error detection and handling
- ‚úÖ Authentication error detection
- ‚úÖ Session rollback on error
- ‚úÖ Session commit on success
- ‚úÖ Session connection testing
- ‚úÖ Multiple pooler URLs tried
- ‚úÖ Pooler connection testing
- ‚úÖ SQLite fallback when no credentials
- ‚úÖ Service role key validation
- ‚úÖ text() wrapper handling

**Integration Tests (8 passing, 2 skipped):**
- ‚úÖ Connection pooler connectivity
- ‚úÖ Session transaction handling
- ‚úÖ Connection pooler timeout configuration
- ‚úÖ IPv4-only connection verification
- ‚úÖ Error handling on bad queries
- ‚úÖ Connection pooler vs direct connection
- ‚è≠Ô∏è US Session mode pooler (expected to fail)
- ‚è≠Ô∏è US Transaction mode pooler (expected to fail)
- ‚úÖ Connection recovery after timeout
- ‚úÖ Pool pre-ping functionality

**Test Results:**
```
Unit Tests: 13/13 PASSED
Integration Tests: 8/8 PASSED (2 skipped as expected)
End-to-end connection: ‚úÖ PostgreSQL 17.4 via EU pooler
```

## File Changes

### Modified Files

#### src/mcli/ml/database/session.py
**Lines changed:** 220 lines modified

**Key Changes:**
- Refactored database initialization logic
- Prioritize `DATABASE_URL` environment variable
- Changed pooler regions from US to EU (verified working)
- Removed Streamlit module-level import
- Added `text()` wrapper for SQL queries
- Fixed code structure and indentation
- Enhanced error handling with connection recovery

**Diff Summary:**
```diff
- try:
-     engine = create_engine(settings.database.url, **settings.get_database_config())
- except (AttributeError, Exception) as e:
-     # Fallback logic...
+ # Prioritize DATABASE_URL environment variable over settings
+ import os
+ database_url = os.getenv("DATABASE_URL")
+
+ # Check if DATABASE_URL has placeholder password
+ if database_url and "your_password" in database_url:
+     database_url = None
+
+ # If no DATABASE_URL, try settings, then Supabase poolers

- pooler_urls = [
-     f"postgresql://...@aws-0-us-east-1.pooler.supabase.com:5432/postgres",
-     f"postgresql://...@aws-0-us-west-1.pooler.supabase.com:6543/postgres",
- ]
+ pooler_urls = [
+     f"postgresql://...@aws-1-eu-north-1.pooler.supabase.com:5432/postgres",
+     f"postgresql://...@aws-1-eu-north-1.pooler.supabase.com:6543/postgres",
+ ]

- import streamlit as st
- st.info(f"üîó Using Supabase connection pooler")
+ import logging
+ logger = logging.getLogger(__name__)
+ logger.info(f"üîó Using Supabase connection pooler")

- conn.execute("SELECT 1")
+ from sqlalchemy import text
+ conn.execute(text("SELECT 1"))
```

#### tests/unit/test_supabase_connection.py
**Lines changed:** 11 lines modified

**Key Changes:**
- Updated `test_session_connection_test` to handle `text()` wrapper
- Fixed assertion to check TextClause object properly
- All tests now passing with SQLAlchemy 2.0 compatibility

**Diff Summary:**
```diff
- call_args = str(mock_session.execute.call_args)
- assert "SELECT 1" in call_args or "select 1" in call_args.lower()
+ call_args = mock_session.execute.call_args
+ sql_clause = str(call_args[0][0])
+ assert "SELECT 1" in sql_clause or "select 1" in sql_clause.lower()
```

#### uv.lock
**Lines changed:** 9898 new lines

**Changes:**
- Updated package lock file with new dependencies
- Resolved dependency versions

### Configuration Files Modified

#### .devcontainer/devcontainer.json
**Lines changed:** 36 lines modified
- Development container configuration updates

### Documentation Added

#### docs/debugging/supabase_connection_fix.md
**Status:** Created in previous version (0.8.3)
- Comprehensive debugging guide for IPv6 connection issues
- Configuration options and troubleshooting steps

### New Files (Unrelated to this fix)

The following files were added between versions but are not part of the database connection fix:
- `DEPLOYMENT_STATUS.md` (223 lines)
- `GRAVITY_VIZ_README.md` (54 lines)
- `docs/COMMAND_CONSOLIDATION.md` (154 lines)
- `src/mcli/app/commands_cmd.py` (741 lines)
- `streamlit_gravity_app.py` (17 lines)
- `streamlit_requirements.txt` (5 lines)
- `test_pages_import.py` (58 lines)

## Deployment Instructions

### For Streamlit Cloud

1. **Update Streamlit Cloud Secrets:**

Add the following to your Streamlit Cloud secrets (Settings ‚Üí Secrets):

```toml
[secrets]
DATABASE_URL = "postgresql://postgres.uljsqvwkomdrlnofmlad:servicetoanothertoastATp3%23Q79@aws-1-eu-north-1.pooler.supabase.com:5432/postgres"
SUPABASE_URL = "https://uljsqvwkomdrlnofmlad.supabase.co"
SUPABASE_SERVICE_ROLE_KEY = "your_service_role_key"
```

2. **Verify Connection:**
   - Navigate to trading dashboard
   - Check for successful database connection message
   - Verify portfolio data loads correctly

3. **Monitor Logs:**
   - Look for: `üîó Using Supabase connection pooler` or `üîó Database URL: postgresql://...`
   - Verify no IPv6 connection errors

### For Local Development

1. **Update .env file:**

```bash
DATABASE_URL=postgresql://postgres.uljsqvwkomdrlnofmlad:servicetoanothertoastATp3%23Q79@aws-1-eu-north-1.pooler.supabase.com:5432/postgres
```

2. **Test connection:**

```bash
python3 -c "
from mcli.ml.database.session import get_session
from sqlalchemy import text
with get_session() as session:
    result = session.execute(text('SELECT 1'))
    print('‚úÖ Connection successful!')
"
```

## Breaking Changes

None. This release maintains full backward compatibility.

## Known Issues

1. **US Region Poolers:** US-based poolers (aws-0-us-east-1, aws-0-us-west-1) fail with "Tenant or user not found" error. Use EU poolers instead.

2. **Service Role Key with Pooler:** Connection pooler authentication with service role key works but shows a warning. For optimal performance, use actual database password.

## Migration Guide

No migration required. The fix is transparent to existing code.

## Performance Impact

- **Connection Time:** Slightly improved due to pooler caching
- **Query Performance:** No change
- **Reliability:** Significantly improved on Streamlit Cloud

## Security Considerations

- Database password is URL-encoded in connection string
- Connection pooler uses PostgreSQL wire protocol (secure)
- Service role key authentication supported as fallback

## Contributors

- Fixed by: Claude Code
- Verified by: Integration and unit tests

## Related Issues

- Fixes: IPv6 connection failures on Streamlit Cloud
- Resolves: Trading dashboard non-functional in production
- Addresses: "Cannot assign requested address" error

## References

- [Supabase Connection Pooling Docs](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)
- [SQLAlchemy 2.0 Migration](https://docs.sqlalchemy.org/en/20/changelog/migration_20.html)
- [IPv6 Connectivity Issues](docs/debugging/supabase_connection_fix.md)

---

**Version:** 0.8.4
**Previous Version:** 0.8.3
**Git Tag:** v0.8.4
**Commit:** 610494e
