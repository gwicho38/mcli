# Release Notes - Version 7.8.0

**Release Date:** October 16, 2025
**Type:** Feature Release

## Overview

Added intelligent PDF compression capability with selective color preservation to the PDF workflow. This feature enables users to compress large PDF documents while maintaining quality for specific pages (e.g., color photos) and converting others to grayscale for maximum space savings.

## New Features

### PDF Compress Command

Added `mcli workflow pdf compress` command with intelligent compression and selective color preservation.

**Key Capabilities:**
- **Multi-level compression:** light, medium, aggressive, ultra, smart (default)
- **Selective color preservation:** Specify pages to keep in color (e.g., passport photos)
- **Target size optimization:** Automatically adjusts compression to meet size requirements
- **DPI control:** Configurable DPI for balancing quality and file size
- **Grayscale conversion:** Automatic conversion of non-color-critical pages
- **Smart retry logic:** Automatically retries with more aggressive settings if target size not met

**Usage:**
```bash
# Basic compression
mcli workflow pdf compress document.pdf

# With selective color preservation
mcli workflow pdf compress document.pdf --color-pages "3,4" --level ultra

# Target specific file size
mcli workflow pdf compress document.pdf --target-size 1.0 --dpi 90

# Specify output file
mcli workflow pdf compress document.pdf -o compressed.pdf
```

**Compression Levels:**
- `light` - 90/85% quality (color/grayscale) - Minimal compression, high quality
- `medium` - 80/70% quality - Balanced compression and quality
- `aggressive` - 65/45% quality - Maximum compression, lower quality
- `ultra` - 55/35% quality - Ultra compression for minimum file size
- `smart` - 85/65% quality (default) - Intelligent per-page optimization

**Options:**
- `--level/-l` - Compression level (default: smart)
- `--color-pages/-c` - Pages to keep in color (e.g., "3,4" or "3-5,8")
- `--target-size/-t` - Target size in MB (will auto-adjust compression)
- `--dpi` - DPI for images (default: 150)
- `--keep-color` - Keep all pages in color (no grayscale conversion)
- `--output/-o` - Output compressed PDF file path

## Technical Implementation

### Compression Algorithm

1. **Per-page Processing:**
   - Loads each page individually as a pixmap
   - Applies DPI scaling based on user preference
   - Converts to grayscale for non-color pages
   - Applies JPEG compression with level-appropriate quality settings

2. **Smart Retry Logic:**
   - If target size specified and initial compression exceeds target
   - Automatically retries with more aggressive compression settings
   - Provides user feedback on compression attempts

3. **Color Page Preservation:**
   - Page range parser supports individual pages (e.g., "3,4")
   - Supports page ranges (e.g., "3-5,8-10")
   - Color pages maintain higher JPEG quality settings
   - Non-color pages converted to grayscale with lower quality for maximum compression

### Test Coverage

Added comprehensive test suite (`tests/unit/test_pdf_compress.py`) with 24 tests covering:
- Page range parsing (single pages, ranges, mixed formats)
- Compression settings for all levels
- DPI scaling calculations
- JPEG quality selection for color/grayscale pages
- Size reduction calculations
- Integration test placeholders

**Test Results:** All 24 tests passing âœ…

## Use Cases

### Real-World Example
Successfully compressed a 10.73 MB Spanish consulate document to 0.81 MB (92.5% reduction) while:
- Preserving color passport photos on pages 3-4
- Converting 18 certificate/form pages to grayscale
- Maintaining legibility of all text content
- Meeting 1 MB file size requirement for submission

### Common Scenarios
- **Government document submissions** with strict file size limits
- **Email attachments** that need to meet size constraints
- **Archival storage** to save disk space
- **Web uploads** with size restrictions
- **Mobile viewing** to reduce download time

## Dependencies

Requires PyMuPDF (fitz) for PDF compression:
```bash
pip install PyMuPDF
```

## Files Changed

### New Files
- `tests/unit/test_pdf_compress.py` - Comprehensive test suite for PDF compression

### Modified Files
- `~/.mcli/commands/pdf-processor.json` - Updated with compress command implementation
- `uv.lock` - Dependency lock file updates

## Breaking Changes

None. This is a purely additive feature release.

## Performance Considerations

- **Memory Usage:** Processes pages individually to minimize memory footprint
- **Processing Time:** ~1-2 seconds per page on Apple M4 Pro
- **Disk I/O:** Creates temporary compressed pages before final assembly

## Known Limitations

1. **Requires PyMuPDF:** Will not work without PyMuPDF library installed
2. **Text Extraction:** Very low quality settings may reduce OCR accuracy
3. **Image Fidelity:** Ultra compression may reduce photo quality significantly
4. **Page-by-Page:** Cannot preserve specific regions within a page (entire page is color or grayscale)

## Upgrade Notes

No special upgrade steps required. Install PyMuPDF if not already present:
```bash
pip install PyMuPDF
```

## Future Enhancements

Potential improvements for future releases:
- Region-based color preservation (preserve specific areas within pages)
- Batch processing with progress tracking
- Preview mode to visualize compression results
- PDF/A compliance options
- Custom compression profiles
- Integration with cloud storage services

## Credits

Feature implemented to solve a real-world problem: compressing a 10.73 MB Spanish consulate document to under 1 MB while preserving color passport photos.

---

**Version:** 7.8.0
**Previous Version:** 7.7.2
**Git Tag:** v7.8.0
